<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartMirror Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header h1 span {
            color: #7c3aed;
        }

        .tabs {
            display: flex;
            gap: 8px;
            padding: 20px 40px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #a0a0a0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: #7c3aed;
            border-color: #7c3aed;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #a0a0a0;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .stat-card .value.green { color: #22c55e; }
        .stat-card .value.blue { color: #3b82f6; }
        .stat-card .value.purple { color: #a855f7; }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s ease;
        }

        .progress-bar.weekly { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .progress-bar.monthly { background: linear-gradient(90deg, #a855f7, #7c3aed); }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: #a0a0a0;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .section-description {
            color: #a0a0a0;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .section-highlight {
            border: 2px solid #7c3aed;
        }
        
        .section-highlight-green {
            border: 2px solid #22c55e;
        }
        
        .section-description-sm {
            color: #a0a0a0;
            margin-bottom: 12px;
            font-size: 13px;
            text-align: center;
        }

        .btn {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #6d28d9;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-telegram {
            background: #0088cc;
        }

        .btn-telegram:hover {
            background: #006699;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-gradient-purple {
            background: linear-gradient(90deg, #7c3aed, #a855f7);
        }
        
        .btn-gradient-purple:hover {
            background: linear-gradient(90deg, #6d28d9, #9333ea);
        }
        
        .btn-gradient-green {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }
        
        .btn-gradient-green:hover {
            background: linear-gradient(90deg, #16a34a, #15803d);
        }

        .transaction-list, .message-list {
            list-style: none;
        }

        .transaction-item, .message-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transaction-item:last-child, .message-item:last-child {
            border-bottom: none;
        }

        .transaction-info, .message-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transaction-service, .message-text {
            font-weight: 500;
            font-size: 15px;
        }

        .transaction-client, .message-sender {
            font-size: 13px;
            color: #a0a0a0;
        }

        .transaction-date, .message-time {
            font-size: 12px;
            color: #666;
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: 600;
            color: #22c55e;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #a0a0a0;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .form-group-btn {
            display: flex;
            align-items: flex-end;
        }
        
        .form-group-btn .btn {
            width: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
        }

        .close-btn:hover {
            color: white;
        }

        .goals-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .action-btn {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .action-btn .icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .action-btn .label {
            font-size: 13px;
            color: #a0a0a0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.success {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-badge.pending {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .module-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .module-card.disabled {
            opacity: 0.5;
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .module-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-title .icon {
            font-size: 24px;
        }

        .module-title h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .module-title p {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #22c55e;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .module-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .module-settings .form-group {
            margin-bottom: 0;
        }

        .module-settings label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .module-settings input,
        .module-settings select {
            padding: 8px 12px;
            font-size: 13px;
        }

        .save-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .save-bar.hidden {
            display: none;
        }

        .save-bar p {
            color: #a0a0a0;
            font-size: 14px;
        }
        
        .save-bar-buttons {
            display: flex;
            gap: 12px;
        }
        
        .save-bar-buttons .btn {
            width: auto;
        }

        .position-preview {
            display: grid;
            grid-template-areas: 
                "top_bar top_bar top_bar"
                "top_left top_center top_right"
                "upper_third upper_third upper_third"
                "middle_left middle_center middle_right"
                "lower_third lower_third lower_third"
                "bottom_left bottom_center bottom_right"
                "bottom_bar bottom_bar bottom_bar";
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: repeat(7, 40px);
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 8px;
            max-width: 300px;
            margin: 16px auto;
        }

        .position-cell {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
            transition: all 0.2s;
        }

        .position-cell.active {
            background: rgba(124, 58, 237, 0.5);
            color: white;
        }

        /* ========== RESPONSIVE DESIGN ========== */
        
        /* Tablet breakpoint (1024px and below) */
        @media (max-width: 1024px) {
            .container {
                padding: 24px 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 16px;
            }
            
            .stat-card .value {
                font-size: 28px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .module-settings {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
            
            .position-preview {
                max-width: 100%;
            }
        }
        
        /* Mobile breakpoint (768px and below) */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 12px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            /* Scrollable tabs */
            .tabs {
                padding: 12px 16px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                padding: 12px 16px;
                min-height: 44px;
                white-space: nowrap;
                flex-shrink: 0;
                font-size: 13px;
            }
            
            .container {
                padding: 20px 16px;
                padding-bottom: 100px; /* Space for save bar */
            }
            
            /* Single column stats */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 24px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .value {
                font-size: 32px;
            }
            
            .section {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .section-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .section-header .btn {
                width: 100%;
            }
            
            /* Form rows stack on mobile */
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .form-group input,
            .form-group textarea,
            .form-group select {
                min-height: 44px;
                font-size: 16px; /* Prevents iOS zoom */
            }
            
            /* Touch-friendly buttons */
            .btn {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 15px;
                width: 100%;
            }
            
            .btn-secondary {
                width: auto;
            }
            
            /* Quick actions 2 columns on mobile */
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .action-btn {
                padding: 16px 12px;
                min-height: 80px;
            }
            
            .action-btn .icon {
                font-size: 24px;
                margin-bottom: 6px;
            }
            
            .action-btn .label {
                font-size: 12px;
            }
            
            /* Transaction/message items */
            .transaction-item,
            .message-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px 0;
            }
            
            .transaction-amount {
                font-size: 16px;
            }
            
            /* Goals modal */
            .modal-content {
                margin: 16px;
                padding: 24px 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .goals-form {
                grid-template-columns: 1fr;
            }
            
            /* Module cards */
            .module-card {
                padding: 16px;
            }
            
            .module-header {
                flex-wrap: wrap;
                gap: 12px;
            }
            
            .module-title {
                flex: 1;
                min-width: 200px;
            }
            
            .module-title .icon {
                font-size: 20px;
            }
            
            .module-title h3 {
                font-size: 15px;
            }
            
            .module-settings {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .module-settings .form-group input,
            .module-settings .form-group select {
                padding: 10px 12px;
                font-size: 14px;
                min-height: 44px;
            }
            
            /* Toggle switch touch area */
            .toggle-switch {
                width: 54px;
                height: 30px;
            }
            
            .toggle-slider:before {
                height: 24px;
                width: 24px;
            }
            
            .toggle-switch input:checked + .toggle-slider:before {
                transform: translateX(24px);
            }
            
            /* Save bar */
            .save-bar {
                padding: 12px 16px;
                flex-direction: column;
                gap: 12px;
            }
            
            .save-bar p {
                text-align: center;
            }
            
            .save-bar-buttons {
                display: flex;
                gap: 8px;
                width: 100%;
            }
            
            .save-bar-buttons .btn {
                flex: 1;
                width: auto;
            }
            
            /* Position preview */
            .position-preview {
                grid-template-rows: repeat(7, 32px);
                max-width: 100%;
                margin: 12px 0;
            }
            
            .position-cell {
                font-size: 8px;
            }
            
            /* Delete button in user list */
            .message-item .btn-danger {
                width: 100%;
                margin-top: 8px;
            }
        }
        
        /* Small phone breakpoint (480px and below) */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .tab {
                padding: 10px 14px;
                font-size: 12px;
            }
            
            .stat-card .value {
                font-size: 28px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-btn {
                padding: 12px 8px;
                min-height: 70px;
            }
            
            .action-btn .icon {
                font-size: 20px;
            }
            
            .section h2 {
                font-size: 16px;
            }
            
            .module-title {
                min-width: 150px;
            }
            
            .empty-state {
                padding: 24px 16px;
                font-size: 14px;
            }
        }
        
        /* Landscape phone */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal-content {
                max-height: 80vh;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* High DPI / touch device improvements */
        @media (hover: none) and (pointer: coarse) {
            .tab:hover,
            .action-btn:hover,
            .btn:hover {
                transform: none;
            }
            
            .action-btn:active {
                background: rgba(255, 255, 255, 0.15);
            }
            
            .btn:active {
                opacity: 0.8;
            }
        }
        
        /* Services Grid */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .service-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .service-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .service-card .price {
            color: #10b981;
            font-size: 24px;
            font-weight: 600;
        }
        
        .service-card .duration {
            color: #666;
            font-size: 14px;
            margin-top: 4px;
        }
        
        .service-card .description {
            color: #888;
            font-size: 13px;
            margin-top: 8px;
        }
        
        .service-card .actions {
            margin-top: 16px;
            display: flex;
            gap: 8px;
        }
        
        .service-card .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .service-inactive {
            opacity: 0.5;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .badge.active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .user-display {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-name {
            font-weight: 500;
            color: #fff;
        }
        
        .user-role {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .user-role.admin {
            background: rgba(124, 58, 237, 0.3);
            color: #a78bfa;
        }
        
        .user-role.barber {
            background: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ü™û <span>SmartMirror</span> Admin</h1>
        <div id="userDisplay" class="user-display">
            <span class="user-name">Loading...</span>
        </div>
    </header>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('budget')">üí∞ Budget</button>
        <button class="tab" onclick="switchTab('services')">‚úÇÔ∏è Services</button>
        <button class="tab admin-only" onclick="switchTab('barbers')">üë• Team</button>
        <button class="tab admin-only" onclick="switchTab('mirrors')">ü™û Mirrors</button>
        <button class="tab" onclick="switchTab('telegram')">üí¨ Telegram Bot</button>
        <button class="tab" onclick="switchTab('controls')">üéõÔ∏è Mirror Controls</button>
        <button class="tab admin-only" onclick="switchTab('modules')">üß© Modules</button>
    </div>

    <div class="container">
        <!-- Budget Tab -->
        <div id="budget-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Weekly Goal Progress</h3>
                    <div class="value green" id="weeklyEarned">$0</div>
                    <div class="progress-container">
                        <div class="progress-bar weekly" id="weeklyProgress" style="width: 0%"></div>
                    </div>
                    <div class="progress-label">
                        <span id="weeklyPercent">0%</span>
                        <span id="weeklyGoal">Goal: $0</span>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>Monthly Goal Progress</h3>
                    <div class="value purple" id="monthlyEarned">$0</div>
                    <div class="progress-container">
                        <div class="progress-bar monthly" id="monthlyProgress" style="width: 0%"></div>
                    </div>
                    <div class="progress-label">
                        <span id="monthlyPercent">0%</span>
                        <span id="monthlyGoal">Goal: $0</span>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>Remaining This Week</h3>
                    <div class="value blue" id="weeklyRemaining">$0</div>
                    <p style="color: #666; font-size: 13px; margin-top: 8px;">to reach weekly goal</p>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Add New Earning</h2>
                </div>
                <form id="addEarningForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amount">Amount ($)</label>
                            <input type="number" id="amount" placeholder="45" required min="1" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="service">Service</label>
                            <input type="text" id="service" placeholder="Haircut" required>
                        </div>
                        <div class="form-group">
                            <label for="client">Client Name</label>
                            <input type="text" id="client" placeholder="John" required>
                        </div>
                        <div class="form-group form-group-btn">
                            <button type="submit" class="btn">+ Add Earning</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Recent Transactions</h2>
                    <button class="btn btn-secondary" onclick="openGoalsModal()">Edit Goals</button>
                </div>
                <ul class="transaction-list" id="transactionList">
                    <li class="loading">Loading transactions...</li>
                </ul>
            </div>
        </div>

        <!-- Services Tab -->
        <div id="services-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Manage Services</h2>
                    <button class="btn" onclick="openAddServiceModal()">+ Add Service</button>
                </div>
                <p class="section-description">
                    These services appear in the Telegram booking flow. Customers can book these when using @BarberMirrorBot.
                </p>
                <div id="servicesList" class="services-grid">
                    <div class="loading">Loading services...</div>
                </div>
            </div>
        </div>

        <!-- Barbers Tab (Admin Only) -->
        <div id="barbers-tab" class="tab-content admin-only">
            <div class="section">
                <div class="section-header">
                    <h2>Team Management</h2>
                    <button class="btn" onclick="openAddBarberModal()">+ Add Barber</button>
                </div>
                <p class="section-description">
                    Manage your barbers and their access levels. Admins can manage the entire shop, barbers can only view their own data.
                </p>
                <div id="barbersList" class="services-grid">
                    <div class="loading">Loading team...</div>
                </div>
            </div>
        </div>

        <!-- Mirrors Tab (Admin Only) -->
        <div id="mirrors-tab" class="tab-content admin-only">
            <div class="section">
                <div class="section-header">
                    <h2>Mirror Devices</h2>
                    <button class="btn" onclick="openAddMirrorModal()">+ Add Mirror</button>
                </div>
                <p class="section-description">
                    Register and manage SmartMirror devices. Generate registration codes to connect new mirrors to your shop.
                </p>
                <div id="mirrorsList" class="services-grid">
                    <div class="loading">Loading mirrors...</div>
                </div>
            </div>
        </div>

        <!-- Telegram Tab -->
        <div id="telegram-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Send Message to Mirror</h2>
                </div>
                <p class="section-description">
                    Simulate sending a Telegram message that will appear on the mirror display.
                </p>
                <form id="sendMessageForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="senderName">Sender Name</label>
                            <input type="text" id="senderName" placeholder="Customer" required>
                        </div>
                        <div class="form-group">
                            <label for="messageText">Message</label>
                            <input type="text" id="messageText" placeholder="Your message here..." required>
                        </div>
                        <div class="form-group form-group-btn">
                            <button type="submit" class="btn btn-telegram">Send to Mirror</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Quick Bot Commands</h2>
                </div>
                <div class="quick-actions">
                    <button class="action-btn" onclick="sendBotCommand('book')">
                        <div class="icon">üìÖ</div>
                        <div class="label">Book Appointment</div>
                    </button>
                    <button class="action-btn" onclick="sendBotCommand('bookings')">
                        <div class="icon">üìã</div>
                        <div class="label">My Bookings</div>
                    </button>
                    <button class="action-btn" onclick="sendBotCommand('contact')">
                        <div class="icon">üìû</div>
                        <div class="label">Contact Shop</div>
                    </button>
                    <button class="action-btn" onclick="sendBotCommand('hours')">
                        <div class="icon">üïê</div>
                        <div class="label">Shop Hours</div>
                    </button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Message History</h2>
                    <button class="btn btn-secondary" onclick="loadMessages()">Refresh</button>
                </div>
                <ul class="message-list" id="messageList">
                    <li class="loading">Loading messages...</li>
                </ul>
            </div>
        </div>

        <!-- Controls Tab -->
        <div id="controls-tab" class="tab-content">
            <div class="section section-highlight">
                <div class="section-header">
                    <h2>Register Customer</h2>
                </div>
                <p class="section-description">
                    Register a new customer's face when they sit in the chair. The mirror will capture their face.
                </p>
                <form id="registerCustomerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Customer Name</label>
                            <input type="text" id="customerName" placeholder="John" required>
                        </div>
                        <div class="form-group form-group-btn">
                            <button type="submit" class="btn btn-gradient-purple">Capture & Register</button>
                        </div>
                    </div>
                </form>
                <div id="registrationStatus" style="display: none; margin-top: 16px; padding: 12px; border-radius: 8px;"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Registered Customers</h2>
                    <button class="btn btn-secondary" onclick="loadRegisteredUsers()">Refresh</button>
                </div>
                <ul class="message-list" id="registeredUsersList">
                    <li class="loading">Loading...</li>
                </ul>
            </div>

            <div class="section section-highlight-green">
                <div class="section-header">
                    <h2>Log Service</h2>
                </div>
                <p class="section-description">
                    Record what service you provided to a customer. This helps track their history for future visits.
                </p>
                <form id="logServiceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serviceCustomer">Customer</label>
                            <select id="serviceCustomer" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px;">
                                <option value="">Select customer...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serviceType">Service</label>
                            <select id="serviceType" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px;">
                                <option value="Haircut">Haircut</option>
                                <option value="Fade">Fade</option>
                                <option value="Beard Trim">Beard Trim</option>
                                <option value="Fade + Beard">Fade + Beard</option>
                                <option value="Lineup">Lineup</option>
                                <option value="Hot Towel Shave">Hot Towel Shave</option>
                                <option value="Kids Cut">Kids Cut</option>
                                <option value="Senior Cut">Senior Cut</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serviceAmount">Amount ($)</label>
                            <input type="number" id="serviceAmount" placeholder="25" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label for="serviceNotes">Notes (optional)</label>
                            <input type="text" id="serviceNotes" placeholder="e.g., Asked for shorter on sides">
                        </div>
                        <div class="form-group form-group-btn">
                            <button type="submit" class="btn btn-gradient-green">Log Service
                            </button>
                        </div>
                    </div>
                </form>
                <div id="serviceStatus" style="display: none; margin-top: 16px; padding: 12px; border-radius: 8px;"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Mirror Controls</h2>
                </div>
                <p class="section-description">
                    Send commands to the SmartMirror remotely.
                </p>
                <div class="quick-actions">
                    <button class="action-btn" onclick="sendMirrorCommand('detect_face')">
                        <div class="icon">üë§</div>
                        <div class="label">Detect Face</div>
                    </button>
                    <button class="action-btn" onclick="sendMirrorCommand('play_greeting')">
                        <div class="icon">üîä</div>
                        <div class="label">Play Greeting</div>
                    </button>
                    <button class="action-btn" onclick="sendMirrorCommand('show_messages')">
                        <div class="icon">üí¨</div>
                        <div class="label">Show Messages</div>
                    </button>
                    <button class="action-btn" onclick="sendMirrorCommand('show_appointments')">
                        <div class="icon">üìÖ</div>
                        <div class="label">Show Appointments</div>
                    </button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>System Status</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Mirror Status</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="status-badge success">Online</span>
                            <span style="color: #666; font-size: 13px;">Connected</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Last Face Detection</h3>
                        <div style="color: #a0a0a0; font-size: 14px;" id="lastDetection">No recent detection</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modules Tab -->
        <div id="modules-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>Mirror Layout</h2>
                </div>
                <p class="section-description">
                    Choose which modules to show on your mirror and where to position them. Changes are saved automatically.
                </p>
                
                <div id="modulesContainer">
                    <div class="loading">Loading module configuration...</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>Position Guide</h2>
                </div>
                <p class="section-description-sm">
                    This is how positions appear on your mirror:
                </p>
                <div class="position-preview">
                    <div class="position-cell" style="grid-area: top_bar;">top_bar</div>
                    <div class="position-cell" style="grid-area: top_left;">top_left</div>
                    <div class="position-cell" style="grid-area: top_center;">top_center</div>
                    <div class="position-cell" style="grid-area: top_right;">top_right</div>
                    <div class="position-cell" style="grid-area: upper_third;">upper_third</div>
                    <div class="position-cell" style="grid-area: middle_center;">middle_center</div>
                    <div class="position-cell" style="grid-area: lower_third;">lower_third</div>
                    <div class="position-cell" style="grid-area: bottom_left;">bottom_left</div>
                    <div class="position-cell" style="grid-area: bottom_center;">bottom_center</div>
                    <div class="position-cell" style="grid-area: bottom_right;">bottom_right</div>
                    <div class="position-cell" style="grid-area: bottom_bar;">bottom_bar</div>
                </div>
            </div>
        </div>
    </div>

    <div class="save-bar hidden" id="saveBar">
        <p>You have unsaved changes</p>
        <div class="save-bar-buttons">
            <button class="btn btn-secondary" onclick="cancelModuleChanges()">Cancel</button>
            <button class="btn" onclick="saveModuleConfig()">Save & Apply</button>
        </div>
    </div>

    <div class="modal" id="goalsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Goals</h3>
                <button class="close-btn" onclick="closeGoalsModal()">&times;</button>
            </div>
            <form id="goalsForm">
                <div class="goals-form">
                    <div class="form-group">
                        <label for="weeklyGoalInput">Weekly Goal ($)</label>
                        <input type="number" id="weeklyGoalInput" placeholder="2000" required min="1">
                    </div>
                    <div class="form-group">
                        <label for="monthlyGoalInput">Monthly Goal ($)</label>
                        <input type="number" id="monthlyGoalInput" placeholder="8000" required min="1">
                    </div>
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 16px;">Save Goals</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div class="modal" id="serviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="serviceModalTitle">Add Service</h3>
                <button class="close-btn" onclick="closeServiceModal()">&times;</button>
            </div>
            <form id="serviceForm">
                <input type="hidden" id="serviceId">
                <div class="form-group">
                    <label for="serviceName">Service Name</label>
                    <input type="text" id="serviceName" placeholder="Haircut" required>
                </div>
                <div class="form-group">
                    <label for="servicePrice">Price ($)</label>
                    <input type="number" id="servicePrice" placeholder="35" required min="1" step="0.01">
                </div>
                <div class="form-group">
                    <label for="serviceDuration">Duration (minutes)</label>
                    <input type="number" id="serviceDuration" placeholder="30" required min="5" value="30">
                </div>
                <div class="form-group">
                    <label for="serviceDescription">Description (optional)</label>
                    <input type="text" id="serviceDescription" placeholder="Standard haircut service">
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 16px;">Save Service</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Barber Modal -->
    <div class="modal" id="barberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="barberModalTitle">Add Barber</h3>
                <button class="close-btn" onclick="closeBarberModal()">&times;</button>
            </div>
            <form id="barberForm">
                <input type="hidden" id="barberId">
                <div class="form-group">
                    <label for="barberName">Name</label>
                    <input type="text" id="barberName" placeholder="John Smith" required>
                </div>
                <div class="form-group">
                    <label for="barberEmail">Email (optional)</label>
                    <input type="email" id="barberEmail" placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label for="barberPhone">Phone (optional)</label>
                    <input type="tel" id="barberPhone" placeholder="555-1234">
                </div>
                <div class="form-group">
                    <label for="barberPin">PIN Code (4 digits)</label>
                    <input type="text" id="barberPin" placeholder="1234" required maxlength="4" pattern="[0-9]{4}">
                </div>
                <div class="form-group">
                    <label for="barberRole">Role</label>
                    <select id="barberRole">
                        <option value="barber">Barber</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="barberColor">Color</label>
                    <input type="color" id="barberColor" value="#3498db">
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 16px;">Save Barber</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Mirror Modal -->
    <div class="modal" id="mirrorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="mirrorModalTitle">Add Mirror</h3>
                <button class="close-btn" onclick="closeMirrorModal()">&times;</button>
            </div>
            <form id="mirrorForm">
                <input type="hidden" id="mirrorId">
                <div class="form-group">
                    <label for="mirrorLabel">Mirror Name</label>
                    <input type="text" id="mirrorLabel" placeholder="Station 1" required>
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 16px;">Create Mirror</button>
            </form>
            <div id="mirrorCodeDisplay" style="display: none; margin-top: 20px; text-align: center;">
                <p style="color: #a0a0a0; margin-bottom: 8px;">Registration Code:</p>
                <div style="font-size: 32px; font-weight: bold; letter-spacing: 8px; color: #7c3aed;" id="registrationCode"></div>
                <p style="color: #666; font-size: 12px; margin-top: 8px;">Enter this code on the mirror to connect it</p>
            </div>
        </div>
    </div>

    <script>
        const AUTH_TOKEN = localStorage.getItem('authToken');
        const AUTH_USER = JSON.parse(localStorage.getItem('authUser') || 'null');
        
        async function checkAuth() {
            if (!AUTH_TOKEN) {
                window.location.href = '/admin/login.html';
                return false;
            }
            
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + AUTH_TOKEN }
                });
                const data = await response.json();
                
                if (!data.success) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('authUser');
                    window.location.href = '/admin/login.html';
                    return false;
                }
                
                updateUserDisplay(data.user);
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                return true;
            }
        }
        
        function updateUserDisplay(user) {
            const userEl = document.getElementById('userDisplay');
            if (userEl) {
                userEl.innerHTML = `
                    <span class="user-name">${user.name}</span>
                    <span class="user-role ${user.role}">${user.role}</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                `;
            }
            
            if (user.role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'none';
                });
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('authUser');
            window.location.href = '/admin/login.html';
        }
        
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + AUTH_TOKEN
            };
        }
        
        checkAuth();

        let budgetData = null;

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');

            if (tabName === 'services') {
                loadServices();
            } else if (tabName === 'telegram') {
                loadMessages();
            } else if (tabName === 'controls') {
                loadRegisteredUsers();
            }
        }

        async function loadBudget() {
            try {
                const response = await fetch('/api/budget');
                const data = await response.json();
                budgetData = data;
                updateBudgetUI(data);
            } catch (error) {
                console.error('Failed to load budget:', error);
            }
        }

        function updateBudgetUI(data) {
            const budget = data.budget;
            const transactions = data.recent_transactions || [];

            document.getElementById('weeklyEarned').textContent = '$' + budget.current_week_earned;
            document.getElementById('monthlyEarned').textContent = '$' + budget.current_month_earned;
            document.getElementById('weeklyRemaining').textContent = '$' + Math.max(0, budget.weekly_remaining);
            
            document.getElementById('weeklyProgress').style.width = Math.min(budget.weekly_progress, 100) + '%';
            document.getElementById('monthlyProgress').style.width = Math.min(budget.monthly_progress, 100) + '%';
            
            document.getElementById('weeklyPercent').textContent = budget.weekly_progress + '%';
            document.getElementById('monthlyPercent').textContent = budget.monthly_progress + '%';
            
            document.getElementById('weeklyGoal').textContent = 'Goal: $' + budget.weekly_goal;
            document.getElementById('monthlyGoal').textContent = 'Goal: $' + budget.monthly_goal;

            document.getElementById('weeklyGoalInput').value = budget.weekly_goal;
            document.getElementById('monthlyGoalInput').value = budget.monthly_goal;

            const listEl = document.getElementById('transactionList');
            if (transactions.length === 0) {
                listEl.innerHTML = '<li class="empty-state">No transactions yet</li>';
            } else {
                listEl.innerHTML = transactions.map(t => `
                    <li class="transaction-item">
                        <div class="transaction-info">
                            <span class="transaction-service">${t.service}</span>
                            <span class="transaction-client">${t.client}</span>
                            <span class="transaction-date">${t.date}</span>
                        </div>
                        <span class="transaction-amount">+$${t.amount}</span>
                    </li>
                `).join('');
            }
        }

        // Services Management
        async function loadServices() {
            try {
                const response = await fetch('/api/services?all=true');
                const data = await response.json();
                
                if (data.success) {
                    renderServices(data.services);
                }
            } catch (error) {
                console.error('Error loading services:', error);
                document.getElementById('servicesList').innerHTML = '<div class="error">Failed to load services</div>';
            }
        }

        function renderServices(services) {
            const container = document.getElementById('servicesList');
            
            if (!services || services.length === 0) {
                container.innerHTML = '<div class="empty">No services found. Add your first service!</div>';
                return;
            }
            
            container.innerHTML = services.map(service => `
                <div class="service-card ${service.is_active ? '' : 'service-inactive'}">
                    <h3>
                        ${service.name}
                        <span class="badge ${service.is_active ? 'active' : ''}">${service.is_active ? 'Active' : 'Inactive'}</span>
                    </h3>
                    <div class="price">$${service.price.toFixed(2)}</div>
                    <div class="duration">${service.duration} minutes</div>
                    ${service.description ? `<div class="description">${service.description}</div>` : ''}
                    <div class="actions">
                        <button class="btn btn-sm btn-secondary" onclick="editService(${service.id}, '${service.name}', ${service.price}, ${service.duration}, '${service.description || ''}')">Edit</button>
                        <button class="btn btn-sm ${service.is_active ? 'btn-danger' : ''}" onclick="toggleService(${service.id}, ${!service.is_active})">${service.is_active ? 'Deactivate' : 'Activate'}</button>
                    </div>
                </div>
            `).join('');
        }

        function openAddServiceModal() {
            document.getElementById('serviceModalTitle').textContent = 'Add Service';
            document.getElementById('serviceId').value = '';
            document.getElementById('serviceName').value = '';
            document.getElementById('servicePrice').value = '';
            document.getElementById('serviceDuration').value = '30';
            document.getElementById('serviceDescription').value = '';
            document.getElementById('serviceModal').classList.add('active');
        }

        function editService(id, name, price, duration, description) {
            document.getElementById('serviceModalTitle').textContent = 'Edit Service';
            document.getElementById('serviceId').value = id;
            document.getElementById('serviceName').value = name;
            document.getElementById('servicePrice').value = price;
            document.getElementById('serviceDuration').value = duration;
            document.getElementById('serviceDescription').value = description;
            document.getElementById('serviceModal').classList.add('active');
        }

        function closeServiceModal() {
            document.getElementById('serviceModal').classList.remove('active');
        }

        async function toggleService(id, activate) {
            try {
                const response = await fetch(`/api/services/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: activate })
                });
                const data = await response.json();
                
                if (data.success) {
                    loadServices();
                }
            } catch (error) {
                console.error('Error toggling service:', error);
            }
        }

        document.getElementById('serviceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('serviceId').value;
            const serviceData = {
                name: document.getElementById('serviceName').value,
                price: parseFloat(document.getElementById('servicePrice').value),
                duration: parseInt(document.getElementById('serviceDuration').value),
                description: document.getElementById('serviceDescription').value
            };
            
            try {
                const url = id ? `/api/services/${id}` : '/api/services';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(serviceData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeServiceModal();
                    loadServices();
                } else {
                    alert('Error saving service: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving service:', error);
                alert('Error saving service');
            }
        });

        async function loadMessages() {
            try {
                const response = await fetch('/api/telegram/messages');
                const data = await response.json();
                updateMessagesUI(data.messages || []);
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        function updateMessagesUI(messages) {
            const listEl = document.getElementById('messageList');
            if (messages.length === 0) {
                listEl.innerHTML = '<li class="empty-state">No messages yet</li>';
            } else {
                listEl.innerHTML = messages.map(m => `
                    <li class="message-item">
                        <div class="message-info">
                            <span class="message-text">${escapeHtml(m.text)}</span>
                            <span class="message-sender">${escapeHtml(m.sender)}</span>
                            <span class="message-time">${new Date(m.timestamp).toLocaleString()}</span>
                        </div>
                    </li>
                `).join('');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        document.getElementById('addEarningForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const service = document.getElementById('service').value;
            const client = document.getElementById('client').value;

            try {
                await fetch('/api/budget/transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, service, client })
                });
                
                document.getElementById('amount').value = '';
                document.getElementById('service').value = '';
                document.getElementById('client').value = '';
                
                loadBudget();
            } catch (error) {
                alert('Failed to add earning. Please try again.');
            }
        });

        document.getElementById('sendMessageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const sender = document.getElementById('senderName').value;
            const text = document.getElementById('messageText').value;

            try {
                await fetch('/api/telegram/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sender, text })
                });
                
                document.getElementById('messageText').value = '';
                loadMessages();
                alert('Message sent to mirror!');
            } catch (error) {
                alert('Failed to send message. Please try again.');
            }
        });

        document.getElementById('goalsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const weekly_goal = parseFloat(document.getElementById('weeklyGoalInput').value);
            const monthly_goal = parseFloat(document.getElementById('monthlyGoalInput').value);

            try {
                await fetch('/api/budget/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ weekly_goal, monthly_goal })
                });
                
                closeGoalsModal();
                loadBudget();
            } catch (error) {
                alert('Failed to update goals. Please try again.');
            }
        });

        async function sendBotCommand(command) {
            const messages = {
                'book': 'I would like to book an appointment',
                'bookings': 'Show me my upcoming bookings',
                'contact': 'How can I contact the shop?',
                'hours': 'What are your shop hours?'
            };
            
            try {
                await fetch('/api/telegram/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sender: 'Bot Command', text: messages[command] })
                });
                loadMessages();
            } catch (error) {
                alert('Failed to send command.');
            }
        }

        async function sendMirrorCommand(command) {
            try {
                await fetch('/api/mirror/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                alert('Command sent: ' + command);
            } catch (error) {
                alert('Failed to send command.');
            }
        }

        async function loadRegisteredUsers() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                const users = data.users || [];
                const listEl = document.getElementById('registeredUsersList');
                
                if (users.length === 0) {
                    listEl.innerHTML = '<li class="empty-state">No registered customers yet</li>';
                } else {
                    listEl.innerHTML = users.map(u => `
                        <li class="message-item">
                            <div class="message-info">
                                <span class="message-text">${escapeHtml(u.name)}</span>
                                <span class="message-sender">Visits: ${u.recognition_count || 0}</span>
                                <span class="message-time">Registered: ${u.trained_at || 'Unknown'}</span>
                            </div>
                            <button class="btn btn-danger" style="padding: 8px 16px; font-size: 12px;" onclick="deleteUser(${u.id})">Delete</button>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            try {
                await fetch('/api/users/' + userId, {
                    method: 'DELETE'
                });
                loadRegisteredUsers();
            } catch (error) {
                alert('Failed to delete user.');
            }
        }

        document.getElementById('registerCustomerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value.trim();
            if (!customerName) {
                alert('Please enter a customer name');
                return;
            }
            
            const statusEl = document.getElementById('registrationStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(124, 58, 237, 0.2)';
            statusEl.style.color = '#a855f7';
            statusEl.innerHTML = 'üì∑ Sending capture command to mirror... Have the customer look at the mirror.';
            
            try {
                const response = await fetch('/api/users/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: customerName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.style.background = 'rgba(34, 197, 94, 0.2)';
                    statusEl.style.color = '#22c55e';
                    statusEl.innerHTML = '‚úÖ Registration initiated! The mirror is capturing ' + customerName + "'s face.";
                    document.getElementById('customerName').value = '';
                    
                    setTimeout(() => {
                        loadRegisteredUsers();
                    }, 3000);
                } else {
                    statusEl.style.background = 'rgba(239, 68, 68, 0.2)';
                    statusEl.style.color = '#ef4444';
                    statusEl.innerHTML = '‚ùå ' + (data.message || 'Registration failed');
                }
            } catch (error) {
                statusEl.style.background = 'rgba(239, 68, 68, 0.2)';
                statusEl.style.color = '#ef4444';
                statusEl.innerHTML = '‚ùå Failed to initiate registration. Please try again.';
            }
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        });

        function openGoalsModal() {
            document.getElementById('goalsModal').classList.add('active');
        }

        function closeGoalsModal() {
            document.getElementById('goalsModal').classList.remove('active');
        }

        document.getElementById('goalsModal').addEventListener('click', (e) => {
            if (e.target.id === 'goalsModal') closeGoalsModal();
        });

        async function populateCustomerDropdown() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                const users = data.users || [];
                const select = document.getElementById('serviceCustomer');
                
                select.innerHTML = '<option value="">Select customer...</option>' + 
                    users.map(u => `<option value="${u.id}">${escapeHtml(u.name)}</option>`).join('');
            } catch (error) {
                console.error('Failed to load customers:', error);
            }
        }

        document.getElementById('logServiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerId = document.getElementById('serviceCustomer').value;
            const serviceType = document.getElementById('serviceType').value;
            const amount = document.getElementById('serviceAmount').value;
            const notes = document.getElementById('serviceNotes').value;
            
            if (!customerId) {
                alert('Please select a customer');
                return;
            }
            
            const statusEl = document.getElementById('serviceStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(34, 197, 94, 0.2)';
            statusEl.style.color = '#22c55e';
            statusEl.innerHTML = '‚è≥ Logging service...';
            
            try {
                const response = await fetch('/api/users/' + customerId + '/service', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        service: serviceType,
                        amount: parseFloat(amount) || 0,
                        notes: notes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.innerHTML = '‚úÖ Service logged successfully!';
                    document.getElementById('serviceAmount').value = '';
                    document.getElementById('serviceNotes').value = '';
                    document.getElementById('serviceCustomer').value = '';
                    
                    if (amount) {
                        await fetch('/api/budget/transaction', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                amount: parseFloat(amount),
                                service: serviceType,
                                client: document.getElementById('serviceCustomer').options[document.getElementById('serviceCustomer').selectedIndex]?.text || 'Customer'
                            })
                        });
                        loadBudget();
                    }
                } else {
                    statusEl.style.background = 'rgba(239, 68, 68, 0.2)';
                    statusEl.style.color = '#ef4444';
                    statusEl.innerHTML = '‚ùå ' + (data.message || 'Failed to log service');
                }
            } catch (error) {
                statusEl.style.background = 'rgba(239, 68, 68, 0.2)';
                statusEl.style.color = '#ef4444';
                statusEl.innerHTML = '‚ùå Failed to log service. Please try again.';
            }
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        });

        const origLoadRegisteredUsers = loadRegisteredUsers;
        loadRegisteredUsers = async function() {
            await origLoadRegisteredUsers();
            await populateCustomerDropdown();
        };

        let moduleConfig = null;
        let originalModuleConfig = null;
        const positions = [
            'top_bar', 'top_left', 'top_center', 'top_right',
            'upper_third', 'middle_center', 'lower_third',
            'bottom_left', 'bottom_center', 'bottom_right', 'bottom_bar'
        ];

        const moduleDefinitions = {
            clock: {
                icon: 'üïê',
                title: 'Clock',
                description: 'Display time and date',
                fields: [
                    { key: 'showDate', label: 'Show Date', type: 'checkbox' },
                    { key: 'dateFormat', label: 'Date Format', type: 'text', placeholder: 'dddd, MMMM D, YYYY' }
                ]
            },
            calendar: {
                icon: 'üìÖ',
                title: 'Calendar',
                description: 'Show upcoming events',
                fields: [
                    { key: 'calendarUrl', label: 'Calendar URL (iCal)', type: 'text', placeholder: 'https://...' },
                    { key: 'calendarName', label: 'Calendar Name', type: 'text', placeholder: 'US Holidays' },
                    { key: 'maxEntries', label: 'Max Events', type: 'number', min: 1, max: 20 }
                ]
            },
            weather: {
                icon: 'üå§Ô∏è',
                title: 'Weather',
                description: 'Current weather and forecast',
                fields: [
                    { key: 'location', label: 'City Name', type: 'text', placeholder: 'Chicago' },
                    { key: 'lat', label: 'Latitude', type: 'number', step: 0.0001 },
                    { key: 'lon', label: 'Longitude', type: 'number', step: 0.0001 },
                    { key: 'showForecast', label: 'Show Forecast', type: 'checkbox' }
                ]
            },
            faceRecognition: {
                icon: 'üë§',
                title: 'Face Recognition',
                description: 'Recognize customers and voice commands',
                fields: [
                    { key: 'showVoiceInput', label: 'Show Voice Input', type: 'checkbox' },
                    { key: 'autoScan', label: 'Auto-scan Faces', type: 'checkbox' }
                ]
            },
            telegram: {
                icon: 'üí¨',
                title: 'Telegram Messages',
                description: 'Display messages from Telegram',
                fields: [
                    { key: 'maxMessages', label: 'Max Messages', type: 'number', min: 1, max: 10 }
                ]
            },
            appointments: {
                icon: 'üìã',
                title: 'Appointments',
                description: 'Show today\'s appointments',
                fields: [
                    { key: 'maxAppointments', label: 'Max Appointments', type: 'number', min: 1, max: 10 },
                    { key: 'showAddButton', label: 'Show Add Button', type: 'checkbox' }
                ]
            },
            newsfeed: {
                icon: 'üì∞',
                title: 'News Feed',
                description: 'Display news headlines',
                fields: [
                    { key: 'feedUrl', label: 'RSS Feed URL', type: 'text', placeholder: 'https://...' },
                    { key: 'feedTitle', label: 'Feed Title', type: 'text', placeholder: 'New York Times' }
                ]
            }
        };

        async function loadModuleConfig() {
            try {
                const response = await fetch('/api/modules');
                const data = await response.json();
                moduleConfig = data.modules;
                originalModuleConfig = JSON.parse(JSON.stringify(moduleConfig));
                renderModules();
            } catch (error) {
                console.error('Failed to load module config:', error);
                document.getElementById('modulesContainer').innerHTML = 
                    '<div class="empty-state">Failed to load module configuration</div>';
            }
        }

        function renderModules() {
            const container = document.getElementById('modulesContainer');
            let html = '';

            for (const [key, def] of Object.entries(moduleDefinitions)) {
                const config = moduleConfig[key] || { enabled: false };
                const isEnabled = config.enabled;

                html += `
                    <div class="module-card ${!isEnabled ? 'disabled' : ''}" data-module="${key}">
                        <div class="module-header">
                            <div class="module-title">
                                <span class="icon">${def.icon}</span>
                                <div>
                                    <h3>${def.title}</h3>
                                    <p>${def.description}</p>
                                </div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleModule('${key}', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="module-settings" style="${!isEnabled ? 'opacity: 0.5; pointer-events: none;' : ''}">
                            <div class="form-group">
                                <label>Position</label>
                                <select onchange="updateModuleField('${key}', 'position', this.value)">
                                    ${positions.map(p => `<option value="${p}" ${config.position === p ? 'selected' : ''}>${p.replace('_', ' ')}</option>`).join('')}
                                </select>
                            </div>
                            ${def.fields.map(field => renderField(key, field, config)).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderField(moduleKey, field, config) {
            const value = config[field.key];
            
            if (field.type === 'checkbox') {
                return `
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" ${value ? 'checked' : ''} 
                                onchange="updateModuleField('${moduleKey}', '${field.key}', this.checked)"
                                style="width: auto;">
                            ${field.label}
                        </label>
                    </div>
                `;
            } else if (field.type === 'number') {
                return `
                    <div class="form-group">
                        <label>${field.label}</label>
                        <input type="number" value="${value || ''}" 
                            ${field.min !== undefined ? `min="${field.min}"` : ''}
                            ${field.max !== undefined ? `max="${field.max}"` : ''}
                            ${field.step !== undefined ? `step="${field.step}"` : ''}
                            onchange="updateModuleField('${moduleKey}', '${field.key}', parseFloat(this.value))">
                    </div>
                `;
            } else {
                return `
                    <div class="form-group">
                        <label>${field.label}</label>
                        <input type="text" value="${value || ''}" 
                            placeholder="${field.placeholder || ''}"
                            onchange="updateModuleField('${moduleKey}', '${field.key}', this.value)">
                    </div>
                `;
            }
        }

        function toggleModule(moduleKey, enabled) {
            if (!moduleConfig[moduleKey]) {
                moduleConfig[moduleKey] = { enabled: false, position: 'top_left' };
            }
            moduleConfig[moduleKey].enabled = enabled;
            renderModules();
            showSaveBar();
        }

        function updateModuleField(moduleKey, field, value) {
            if (!moduleConfig[moduleKey]) {
                moduleConfig[moduleKey] = { enabled: true, position: 'top_left' };
            }
            moduleConfig[moduleKey][field] = value;
            showSaveBar();
        }

        function showSaveBar() {
            document.getElementById('saveBar').classList.remove('hidden');
        }

        function hideSaveBar() {
            document.getElementById('saveBar').classList.add('hidden');
        }

        function cancelModuleChanges() {
            moduleConfig = JSON.parse(JSON.stringify(originalModuleConfig));
            renderModules();
            hideSaveBar();
        }

        async function saveModuleConfig() {
            try {
                const response = await fetch('/api/modules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ modules: moduleConfig })
                });

                const data = await response.json();

                if (data.success) {
                    originalModuleConfig = JSON.parse(JSON.stringify(moduleConfig));
                    hideSaveBar();
                    alert('Configuration saved! The mirror will refresh to apply changes.');
                } else {
                    alert('Failed to save: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to save configuration. Please try again.');
            }
        }

        const origSwitchTab = switchTab;
        switchTab = function(tabName) {
            origSwitchTab(tabName);
            if (tabName === 'modules') {
                loadModuleConfig();
            } else if (tabName === 'barbers') {
                loadBarbers();
            } else if (tabName === 'mirrors') {
                loadMirrors();
            }
        };

        async function loadBarbers() {
            try {
                const response = await fetch('/api/auth/barbers', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                renderBarbers(data.barbers || []);
            } catch (error) {
                console.error('Failed to load barbers:', error);
                document.getElementById('barbersList').innerHTML = 
                    '<div class="empty-state">Failed to load team</div>';
            }
        }

        function renderBarbers(barbers) {
            const container = document.getElementById('barbersList');
            if (barbers.length === 0) {
                container.innerHTML = '<div class="empty-state">No team members yet</div>';
                return;
            }

            container.innerHTML = barbers.map(b => `
                <div class="service-card ${!b.is_active ? 'service-inactive' : ''}">
                    <div class="service-info">
                        <span class="service-name" style="display: flex; align-items: center; gap: 8px;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: ${b.color || '#3498db'}"></span>
                            ${b.name}
                        </span>
                        <span class="service-description">${b.email || 'No email'}</span>
                        <span class="badge ${b.role === 'admin' ? 'active' : ''}">${b.role}</span>
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editBarber(${b.id})">Edit</button>
                        ${b.id !== AUTH_USER?.id ? `<button class="btn btn-sm btn-danger" onclick="deleteBarber(${b.id})">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function openAddBarberModal() {
            document.getElementById('barberModalTitle').textContent = 'Add Barber';
            document.getElementById('barberId').value = '';
            document.getElementById('barberName').value = '';
            document.getElementById('barberEmail').value = '';
            document.getElementById('barberPhone').value = '';
            document.getElementById('barberPin').value = '';
            document.getElementById('barberRole').value = 'barber';
            document.getElementById('barberColor').value = '#3498db';
            document.getElementById('barberModal').classList.add('active');
        }

        function closeBarberModal() {
            document.getElementById('barberModal').classList.remove('active');
        }

        async function editBarber(id) {
            try {
                const response = await fetch('/api/auth/barbers', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                const barber = data.barbers.find(b => b.id === id);
                
                if (barber) {
                    document.getElementById('barberModalTitle').textContent = 'Edit Barber';
                    document.getElementById('barberId').value = barber.id;
                    document.getElementById('barberName').value = barber.name;
                    document.getElementById('barberEmail').value = barber.email || '';
                    document.getElementById('barberPhone').value = barber.phone || '';
                    document.getElementById('barberPin').value = barber.pin_code || '';
                    document.getElementById('barberRole').value = barber.role;
                    document.getElementById('barberColor').value = barber.color || '#3498db';
                    document.getElementById('barberModal').classList.add('active');
                }
            } catch (error) {
                alert('Failed to load barber');
            }
        }

        async function deleteBarber(id) {
            if (!confirm('Are you sure you want to remove this team member?')) return;
            
            try {
                const response = await fetch(`/api/auth/barbers/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    loadBarbers();
                } else {
                    alert(data.error || 'Failed to delete');
                }
            } catch (error) {
                alert('Failed to delete team member');
            }
        }

        document.getElementById('barberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('barberId').value;
            const barberData = {
                name: document.getElementById('barberName').value,
                email: document.getElementById('barberEmail').value || null,
                phone: document.getElementById('barberPhone').value || null,
                pin_code: document.getElementById('barberPin').value,
                role: document.getElementById('barberRole').value,
                color: document.getElementById('barberColor').value
            };

            try {
                const url = id ? `/api/auth/barbers/${id}` : '/api/auth/barbers';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(barberData)
                });
                const data = await response.json();

                if (data.success) {
                    closeBarberModal();
                    loadBarbers();
                } else {
                    alert(data.error || 'Failed to save barber');
                }
            } catch (error) {
                alert('Failed to save barber');
            }
        });

        async function loadMirrors() {
            try {
                const response = await fetch('/api/auth/mirrors', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                renderMirrors(data.mirrors || []);
            } catch (error) {
                console.error('Failed to load mirrors:', error);
                document.getElementById('mirrorsList').innerHTML = 
                    '<div class="empty-state">Failed to load mirrors</div>';
            }
        }

        function renderMirrors(mirrors) {
            const container = document.getElementById('mirrorsList');
            if (mirrors.length === 0) {
                container.innerHTML = '<div class="empty-state">No mirrors registered yet</div>';
                return;
            }

            container.innerHTML = mirrors.map(m => `
                <div class="service-card ${!m.is_active ? 'service-inactive' : ''}">
                    <div class="service-info">
                        <span class="service-name">${m.label}</span>
                        <span class="service-description">
                            Status: <span style="color: ${m.status === 'online' ? '#22c55e' : '#ef4444'}">${m.status}</span>
                        </span>
                        ${m.registration_code ? `<span class="badge">Code: ${m.registration_code}</span>` : ''}
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-sm btn-secondary" onclick="regenerateCode(${m.id})">New Code</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMirror(${m.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function openAddMirrorModal() {
            document.getElementById('mirrorModalTitle').textContent = 'Add Mirror';
            document.getElementById('mirrorId').value = '';
            document.getElementById('mirrorLabel').value = '';
            document.getElementById('mirrorCodeDisplay').style.display = 'none';
            document.getElementById('mirrorModal').classList.add('active');
        }

        function closeMirrorModal() {
            document.getElementById('mirrorModal').classList.remove('active');
        }

        async function regenerateCode(id) {
            try {
                const response = await fetch(`/api/auth/mirrors/${id}/regenerate-code`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    loadMirrors();
                    alert('New registration code: ' + data.mirror.registration_code);
                } else {
                    alert(data.error || 'Failed to regenerate code');
                }
            } catch (error) {
                alert('Failed to regenerate code');
            }
        }

        async function deleteMirror(id) {
            if (!confirm('Are you sure you want to remove this mirror?')) return;
            
            try {
                const response = await fetch(`/api/auth/mirrors/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    loadMirrors();
                } else {
                    alert(data.error || 'Failed to delete');
                }
            } catch (error) {
                alert('Failed to delete mirror');
            }
        }

        document.getElementById('mirrorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const label = document.getElementById('mirrorLabel').value;

            try {
                const response = await fetch('/api/auth/mirrors', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ label })
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('registrationCode').textContent = data.mirror.registration_code;
                    document.getElementById('mirrorCodeDisplay').style.display = 'block';
                    loadMirrors();
                } else {
                    alert(data.error || 'Failed to create mirror');
                }
            } catch (error) {
                alert('Failed to create mirror');
            }
        });

        loadBudget();
        setInterval(loadBudget, 30000);
        
        populateCustomerDropdown();
    </script>
</body>
</html>
